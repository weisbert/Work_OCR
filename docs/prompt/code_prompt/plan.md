# Work_OCR 模型管理功能升级计划

## 项目目标
重构OCR模式选择系统，从预设的"高精度/快速/超快速"文字模式，改为基于实际已安装模型的动态选择系统，并提供完整的模型生命周期管理功能。

---

## 🔥 紧急修复: 让现有功能可用 (前置步骤)
**目标**: 不改动架构，只修复模型路径问题，让当前代码能运行

### 问题
- 代码指定 `ch_PP-OCRv4_det_server_infer` 等模型名，但PaddleOCR 3.4.0实际使用 `PP-OCRv5_server_det` 等名称
- 模型存放位置从 `~/.paddleocr/whl/` 变为 `~/.paddlex/official_models/`

### 修复方案
- [ ] 修改 `src/work_ocr/app.py` 中的 `_get_ocr_params()`
  - 使用正确的模型名称（与已安装的模型匹配）
  - 或者使用PaddleOCR默认配置（不指定模型路径）
- [ ] 验证截图→OCR→结果输出全流程可用

### 预计时间: 30分钟

---

## 里程碑1: 基础架构与模型检测
**目标**: 建立模型管理基础设施，能够检测本地已安装模型

### 任务列表
- [ ] 创建 `src/work_ocr/model_manager.py` 模块
  - [ ] 定义 `OCRModel` dataclass (name, type, version, path, size)
  - [ ] 实现 `ModelManager` 类
    - [ ] `scan_installed_models()`: 扫描 `~/.paddlex/official_models/` 目录
    - [ ] `get_model_info(model_name)`: 获取模型详细信息
    - [ ] `is_model_available(model_name)`: 检查模型是否可用
- [ ] 创建 `tests/test_model_manager.py` 单元测试
- [ ] 验证能正确识别已安装的 PP-OCRv3_mobile 和 PP-OCRv5_server 模型

### 验收标准
```python
# 应能正确检测已安装模型
manager = ModelManager()
models = manager.scan_installed_models()
assert "PP-OCRv3_mobile_det" in models
assert "PP-OCRv5_server_rec" in models
```

---

## 里程碑2: 模型删除功能
**目标**: 实现模型删除功能

### 任务列表
- [ ] 扩展 `ModelManager` 类
  - [ ] `delete_model(model_name)`: 安全删除指定模型
  - [ ] `get_model_size(model_name)`: 获取模型占用空间
- [ ] 添加删除确认对话框（防止误删）
- [ ] 创建模型管理UI原型（列表展示）
- [ ] 单元测试覆盖删除逻辑

### 验收标准
- 能正确删除指定模型文件夹
- 删除前弹出确认对话框
- 删除失败时有错误提示

---

## 里程碑3: 可用模型列表与下载
**目标**: 获取可下载模型列表，支持模型下载

### 任务列表
- [ ] 创建 `src/work_ocr/model_repository.py`
  - [ ] 定义支持的模型清单（PP-OCRv3/PP-OCRv4/PP-OCRv5 的 mobile/server 版本）
  - [ ] `get_available_models()`: 返回可下载模型列表
  - [ ] `get_download_url(model_name)`: 获取下载链接
- [ ] 集成 PaddleX 的模型下载机制
  - [ ] 研究 `paddlex` 的模型下载API
  - [ ] 实现 `download_model(model_name, progress_callback)`
- [ ] 创建下载进度UI组件

### 支持的模型矩阵
| 版本 | 类型 | 检测模型 | 识别模型 | 适用场景 |
|------|------|----------|----------|----------|
| PP-OCRv3 | mobile | ✅ | ✅ | 移动端/嵌入式 |
| PP-OCRv3 | server | ✅ | ✅ | 服务器端 |
| PP-OCRv4 | mobile | ✅ | ✅ | 推荐-移动端 |
| PP-OCRv4 | server | ✅ | ✅ | 推荐-高精度 |
| PP-OCRv5 | mobile | ✅ | ✅ | 最新-移动端 |
| PP-OCRv5 | server | ✅ | ✅ | 最新-高精度 |

### 验收标准
- 能列出所有支持的模型
- 能下载缺失模型并显示进度
- 下载完成后模型立即可用

---

## 里程碑4: 重构OCR引擎参数系统
**目标**: 替换原有模式系统，改为基于实际模型的配置

### 任务列表
- [ ] 修改 `src/work_ocr/ocr_engine.py`
  - [ ] 移除固定模式逻辑
  - [ ] 支持通过模型名称动态初始化
  - [ ] 添加参数验证
- [ ] 创建 `OCRConfig` dataclass
  - [ ] `det_model`: 检测模型名称
  - [ ] `rec_model`: 识别模型名称
  - [ ] `use_angle_cls`: 是否使用角度分类
  - [ ] `cpu_threads`: CPU线程数
  - [ ] `det_db_thresh`: 检测阈值
  - [ ] `rec_batch_num`: 识别批大小
- [ ] 更新单元测试

### 验收标准
```python
# 应能通过模型名称初始化
engine = OCREngine(
    det_model="PP-OCRv4_server_det",
    rec_model="PP-OCRv4_server_rec",
    use_angle_cls=True,
    cpu_threads=4
)
```

---

## 里程碑5: 主界面重构 - 模型选择器
**目标**: 替换原有下拉框为动态模型选择界面

### 任务列表
- [ ] 修改 `src/work_ocr/app.py`
  - [ ] 移除 `precision_mode_combo` (高精度/快速/超快速)
  - [ ] 添加 `ModelSelectorWidget` (自定义组件)
    - [ ] 检测模型选择下拉框
    - [ ] 识别模型选择下拉框
    - [ ] 只显示已安装模型
    - [ ] 模型缺失时提示下载
  - [ ] 添加"管理模型"按钮，打开模型管理对话框
- [ ] 记住上次使用的模型组合

### UI草图
```
┌─────────────────────────────────────┐
│ OCR模型配置                          │
├─────────────────────────────────────┤
│ 检测模型: [PP-OCRv4_server_det ▼]   │
│ 识别模型: [PP-OCRv4_server_rec ▼]   │
│                                     │
│ [管理模型...]  [恢复默认]            │
└─────────────────────────────────────┘
```

---

## 里程碑6: 高级参数自定义面板
**目标**: 提供可自定义的OCR参数控制

### 任务列表
- [ ] 创建 `AdvancedParamsWidget` 组件
  - [ ] **性能参数**
    - [ ] CPU线程数滑块 (1-16)
    - [ ] 启用MKL-DNN加速 (复选框, 默认关闭)
    - [ ] 识别批大小 (1-10)
  - [ ] **检测参数**
    - [ ] 检测阈值滑块 (0.1-0.9)
    - [ ] 只检测横向文本 (复选框)
    - [ ] 最小文本尺寸 (像素)
  - [ ] **识别参数**
    - [ ] 启用角度分类 (复选框)
    - [ ] 空格识别 (复选框)
- [ ] 参数说明提示（悬停显示）
- [ ] 参数预设保存/加载

### UI草图
```
┌─────────────────────────────────────┐
│ 高级参数 ▼                          │
├─────────────────────────────────────┤
│ 性能                                 │
│   CPU线程: [====4====]              │
│   [ ] 启用MKL-DNN加速               │
│   批大小: [6 ▼]                     │
│                                     │
│ 检测                                 │
│   阈值: [0.3=======]                │
│   [x] 只检测横向文本                 │
│   最小尺寸: [3] 像素                │
│                                     │
│ 识别                                 │
│   [x] 启用角度分类                   │
│   [x] 识别空格                       │
├─────────────────────────────────────┤
│ [保存为预设] [加载预设] [恢复默认]   │
└─────────────────────────────────────┘
```

---

## 里程碑7: 模型管理对话框
**目标**: 完整的模型管理界面

### 任务列表
- [ ] 创建 `ModelManagerDialog` (QDialog)
  - [ ] **已安装模型** 标签页
    - [ ] 表格展示 (名称/版本/大小/操作)
    - [ ] 删除按钮 (带确认)
    - [ ] 刷新按钮
  - [ ] **可用模型** 标签页
    - [ ] 表格展示 (名称/版本/大小/状态)
    - [ ] 下载按钮
    - [ ] 下载进度条
    - [ ] 批量下载
  - [ ] 底部显示存储空间统计
- [ ] 与主界面集成

### UI草图
```
┌──────────────────────────────────────────┐
│ 模型管理                     [×]         │
├──────────────────────────────────────────┤
│ [已安装模型] [可用模型]                   │
├──────────────────────────────────────────┤
│ 名称              版本      大小    操作  │
│ PP-OCRv3_mobile   v3        8MB    [删除] │
│ PP-OCRv5_server   v5       45MB    [删除] │
│                                         │
├──────────────────────────────────────────┤
│ 已用空间: 53MB / 可用: 100GB    [刷新]    │
└──────────────────────────────────────────┘
```

---

## 里程碑8: 配置持久化与优化
**目标**: 保存用户偏好，优化性能

### 任务列表
- [ ] 扩展 `config.json` 格式
  ```json
  {
    "ocr": {
      "det_model": "PP-OCRv4_server_det",
      "rec_model": "PP-OCRv4_server_rec",
      "advanced_params": {
        "cpu_threads": 4,
        "use_mkldnn": false,
        "det_db_thresh": 0.3,
        "horizontal_only": false,
        "use_angle_cls": true
      },
      "presets": [
        {"name": "高精度", "det_model": "...", ...},
        {"name": "快速", "det_model": "...", ...}
      ]
    }
  }
  ```
- [ ] 实现配置迁移（旧格式→新格式）
- [ ] 启动时自动检测模型变化
- [ ] 优化模型切换时的初始化速度
- [ ] 添加日志记录

---

## 里程碑9: 集成测试与文档
**目标**: 确保功能稳定，文档完整

### 任务列表
- [ ] 集成测试
  - [ ] 模型下载→使用→删除完整流程
  - [ ] 参数调整实时生效
  - [ ] 配置保存/加载
- [ ] 更新 `AGENTS.md`
  - [ ] 新架构说明
  - [ ] 模型管理功能
  - [ ] 参数说明
- [ ] 用户文档
  - [ ] 模型选择指南
  - [ ] 参数调优建议

---

## 依赖与风险

### 技术依赖
- PaddleOCR 3.4.0+ 模型管理机制
- PaddleX 模型下载API
- PySide6 复杂对话框

### 风险与缓解
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| PaddleX API变更 | 高 | 封装下载层，便于替换实现 |
| 模型下载失败 | 中 | 断点续传，失败重试，手动导入备选 |
| 磁盘空间不足 | 中 | 下载前检查空间，显示存储统计 |
| 参数过多导致困惑 | 低 | 提供预设配置，默认隐藏高级选项 |

---

## 当前状态
- [x] 计划制定完成
- [x] 🔥 紧急修复: 让现有功能可用 (已完成 2026-02-02)
- [ ] 里程碑1: 基础架构与模型检测 (未开始)
- [ ] 里程碑2: 模型删除功能 (未开始)
- [ ] 里程碑3: 可用模型列表与下载 (未开始)
- [ ] 里程碑4: 重构OCR引擎参数系统 (未开始)
- [ ] 里程碑5: 主界面重构 - 模型选择器 (未开始)
- [ ] 里程碑6: 高级参数自定义面板 (未开始)
- [ ] 里程碑7: 模型管理对话框 (未开始)
- [ ] 里程碑8: 配置持久化与优化 (未开始)
- [ ] 里程碑9: 集成测试与文档 (未开始)

---

## 记录
- **创建日期**: 2026-02-02
- **作者**: Kimi Code CLI
- **相关文件**: 
  - `src/work_ocr/model_manager.py` (待创建)
  - `src/work_ocr/model_repository.py` (待创建)
  - `src/work_ocr/app.py` (需修改)
  - `src/work_ocr/ocr_engine.py` (需修改)
  - `config.json` (格式需升级)
