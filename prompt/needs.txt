# 基于 Paddle(CPU) 的 OCR 软件需求文档（PRD + SRS 精简版，Python 3.11）

> 目标：把当前需求收敛成可实现、可验收的规格，减少开发“理解偏差”。

---

## 1. 项目概述

### 1.1 背景
用户需要在 **Windows 11 + CPU-only** 环境下，使用 **Python 3.11** 开发一款 OCR 工具，底层基于 :contentReference[oaicite:0]{index=0} / :contentReference[oaicite:1]{index=1}（CPU），用于从截图中高精度提取文本，重点是**类似 Excel 的表格数据**与**英文 Linux 截图文本**。

### 1.2 目标（Goals）
1. 支持截图 OCR：像 :contentReference[oaicite:2]{index=2} 一样框选区域 → 确认/取消 → 自动 OCR → 左侧预览图、右侧结果文本。
2. 表格场景：输出可直接粘贴到 :contentReference[oaicite:3]{index=3} 的 **TSV（`\t` 分隔）**，尽量还原行列布局。
3. 文本场景（英文为主）：尽可能还原换行/缩进/对齐。
4. 提供“表格预处理 Tab”：阈值替换、单位统一、数值/单位分离、工程计数法转换、复制策略等。
5. CPU-only 可用；有 log/进度显示，便于 debug。
6. 代码拆分为 **≤ 5 个 `.py` 文件**，注释全英文。

### 1.3 非目标（Non-goals）
- 不做 OCR 训练/微调。
- 不做复杂的图像编辑（马赛克、画笔、标注等）。
- 不做多页面 PDF 导入（当前仅截图/图片）。
- 不承诺做到与专业表格识别模型同级的结构恢复（目标是“可用、可粘贴、可校正”）。

---

## 2. 用户与使用场景

### 2.1 核心用户画像
- Windows 办公用户：需要快速把截图内容变成可复制文本/表格。
- 工程数据用户：表格中常见 “数值 + 工程单位前缀（f~G）”。

### 2.2 使用场景
1. **表格（最高优先级）**：截图类似 Excel 的数据表 → OCR → 输出 TSV → 一键粘贴回 Excel。
2. **英文 Linux 截图**：debug log / 代码片段 → OCR → 尽可能保持换行、缩进。
3. **中英文混杂（低频）**：可识别，但不作为主要优化目标。

---

## 3. 运行与环境约束

- OS：:contentReference[oaicite:4]{index=4}
- Python：3.11
- Paddle：`paddlepaddle==3.2.0`（CPU）
- OCR：`paddleocr`
- 仅 CPU：禁止依赖 GPU、CUDA。

---

## 4. 产品形态与总体交互

### 4.1 主窗口布局
- 左侧：截图预览区（显示用户确认后的截图）
- 右侧：结果区（可编辑文本框）
- 下方或右侧：log/进度区（进度条 + 文本日志）

### 4.2 Tab 结构
- Tab 1：**OCR 原始结果**
  - 展示 OCR 输出（按当前模式：表格/文本）
- Tab 2：**表格预处理**
  - 输入：来自 Tab1 的表格 TSV
  - 输出：预处理后的 TSV（或数值-only / 单位-only）

### 4.3 必备按钮
- **截图**：进入框选截图模式
- **Copy**：复制当前 Tab 的输出内容到剪贴板
- **Clear**：清空截图预览 + 结果文本 + 预处理输出 + log（或至少清空核心区域）

---

## 5. 截图功能规格

### 5.1 交互流程（Snipaste-like 简化版）
1. 用户点击“截图”或使用全局快捷键进入截图模式
2. 鼠标拖拽框选矩形区域
3. 框选完成后显示浮层按钮：
   - **√ 确认**
   - **× 取消**
4. 快捷键：
   - `Enter` = 确认
   - `Esc` = 取消
5. 确认后：
   - 截图显示在主界面左侧预览区
   - 自动触发 OCR
   - 右侧显示识别结果（并可编辑）

### 5.2 全局快捷键
- 用户可自定义截图快捷键（例如 `Ctrl+Alt+S`）
- 冲突处理：若注册失败（被系统/其他软件占用），需提示用户并拒绝启用该快捷键。

---

## 6. OCR 模式与输出规则

### 6.1 模式
- **表格模式**（重点优化）：输出 TSV（`\t` 分隔列，`\n` 分隔行）
- **文本模式**（英文为主）：输出保留换行/缩进的纯文本

### 6.2 模式选择策略
- 默认：自动检测（启发式）
- 用户可手动切换（下拉框/开关）覆盖自动判断

#### 6.2.1 自动检测建议（可实现口径）
满足以下特征时倾向表格模式：
- 检测框呈多列对齐（x 坐标聚类后列数≥2）
- 文本 token 中出现大量“数字+单位前缀”（如 `281.5u`、`50n`）
否则走文本模式。

### 6.3 表格模式：结构还原算法（MVP）
- 输入：OCR 检测得到的文本框（bbox）与识别文本
- 输出：行列 TSV

#### 6.3.1 行聚类
- 按 bbox 的中心 y 坐标聚类成行（阈值与平均字符高度相关，可配置）

#### 6.3.2 列聚类
- 按 bbox 的中心 x 坐标聚类成列
- 列边界采用“相邻 x 间距阈值”或 1D 聚类（如 k-means/DBSCAN 1D）
- 输出时每行按列索引填入；缺失列用空字符串

#### 6.3.3 分隔符
- 列分隔：`\t`
- 行分隔：`\n`
- 目标：可直接粘贴到 Excel 形成正确列

### 6.4 文本模式：布局保留策略（MVP）
- 按 y 聚类成行
- 行内按 x 排序拼接
- 用空格估计间隔（基于相邻 bbox 的 x gap 映射到空格数）
- 保留 `\n` 换行；缩进使用空格

---

## 7. 表格预处理 Tab：功能规格（核心）

> 预处理 Tab 的输入默认来自“表格模式 TSV”。

### 7.1 支持的数据格式
- 单元格可能是：
  - 工程单位形式：`[+/-]number + prefix`，例：`281.5u`、`-4n`、`1.95m`
  - 纯数字：`123`、`-0.25`
  - 科学计数法：`1.23e-4`、`2.815E-04`
  - 特殊标记：`-`（表示无效/被替换）

> 约束：不会出现 `mA`、`uV` 等带 A/V 后缀的情况。

### 7.2 工程前缀（f ~ G）
支持集合（大小写策略：输入不敏感，输出规范化）：
- `f`(1e-15), `p`(1e-12), `n`(1e-9), `u`(1e-6), `m`(1e-3),
- （空）(1e0),
- `k`(1e3), `M`(1e6), `G`(1e9)

### 7.3 预处理管线顺序（必须固定）
1. **解析**（识别每个单元格的数值与前缀/或科学计数法）
2. **阈值替换**（按阈值单位比较，规则见 7.4）
3. **单位统一**（把所有可解析值转换到用户指定单位前缀）
4. **数值/单位分离（可选）**
5. **工程计数法转换（可选）**
6. 复制策略输出（全量/只数值/只单位）

### 7.4 阈值替换（不取绝对值）
#### 7.4.1 用户输入
- 阈值：例如 `5n`
- 替换目标：`"-"` 或 `"0"`

#### 7.4.2 判定规则（定稿）
- 对每个可解析单元格：
  1) 先换算到阈值的单位（例：阈值 `n`，则把 `-4u` → `-4000n`）
  2) 比较使用“数值本身”：
     - 若 `value_converted < threshold` → 替换为用户选择（`-` 或 `0`）
     - 否则保留进入后续步骤
- 特殊值：
  - 已经是 `-`：保持 `-`
  - 不可解析：保持原字符串，并在 log 中记录“parse failed”

### 7.5 单位统一
- 用户选择目标单位前缀（例如统一到 `u`）
- 所有可解析值转换到该前缀
- 输出规范：
  - 数值部分保留合理精度（默认：最多 6 位有效数字，可配置）
  - 单位前缀为目标前缀

### 7.6 数值与单位分离（可选）
- 选项：启用/禁用
- 启用时：
  - 输出多一列“单位列”（最后一列）
  - 单位列默认输出“目标统一单位前缀”（例如统一到 `u`，则单位列为 `u`）
  - 当某单元格为 `-`：
    - 数值列保持 `-`
    - 单位列仍输出目标单位 `u`（与示例一致）
- Copy 子选项：
  - Copy 全部（含单位列）
  - Copy 只数值（不含单位列）
  - Copy 只单位（仅输出单位列，每行一个单位）

### 7.7 工程单位 ↔ 科学/工程计数法

#### 7.7.1 工程单位 → 科学计数法（SI）
- 例：`281.5u` → `2.815e-04`
- 输出：
  - mantissa + `e` + exponent
  - 默认 4 位有效数字（可配置）

#### 7.7.2 工程单位 → 工程计数法（指数为 3 的倍数）
- 你的修正：`12345` 应输出 `12.3E+03`
- 定义：
  - 目标：`1 ≤ |mantissa| < 1000`
  - 且 exponent 必须为 `3 * k`（k 为整数）
  - mantissa 默认 1 位小数（可配置）
- 输出示例：`12345` → `12.3E+03`

#### 7.7.3 科学计数法 → 工程单位（f~G）
- 支持 `e/E`，指数任意
- 选择一个工程前缀，使得：
  - `1 ≤ |v| < 1000`（v 为缩放后的值）
  - 前缀限制在 f~G；超出范围则使用边界前缀并保留超大/超小数值
- 输出例：`2.815E-04` → `281.5u`

### 7.8 设置记忆（持久化）
#### 7.8.1 需要记住的字段
- 阈值（数值+单位）
- 阈值替换目标（`-` 或 `0`）
- 目标统一单位前缀（f~G）
- 是否启用数值/单位分离
- Copy 策略（全量/只数值/只单位）
- 计数法转换模式（无 / SI科学计数法 / 工程计数法 / 计数法→工程单位）
- 精度相关配置（有效数字/小数位）

#### 7.8.2 存储方式
- 本地 `config.json`（建议路径：`%APPDATA%/<AppName>/config.json`）
- 启动加载，用户修改后自动保存
- 提供“恢复默认”按钮（可选，但建议）

---

## 8. 日志与进度（可验收）

### 8.1 进度阶段（建议固定）
1. Capture start
2. Capture confirmed
3. Preprocess image (optional)
4. OCR detect
5. OCR recognize
6. Layout reconstruction (table/text)
7. Postprocess (tabular preprocess)
8. Ready

### 8.2 日志内容要求
- 每阶段开始/结束时间
- OCR 耗时
- 解析失败样本计数（例如：多少单元格 parse failed）
- 错误堆栈（开发模式可更详细）

---

## 9. 测试与验收

### 9.1 提供的测试文件
- `./test_pic/test_pic1_data.png`：表格截图测试输入
- `./test_pic/test_pic1_data_table_anwser.txt`：对应答案（验收基准）

### 9.2 验收标准（建议最小可验收集）
#### 9.2.1 基础功能
- 能截图、确认/取消正常
- 截图后左侧显示预览，右侧输出 OCR 结果
- Copy 可复制到剪贴板；Clear 可清空内容
- log/进度能显示阶段

#### 9.2.2 表格模式
- 对测试图输出 TSV，可粘贴进 Excel 后列数与预期一致（以 answer 为准）
- 主要数值 token（含符号、小数、单位前缀）识别正确率达到可用水平（建议以该样例“逐格对比”作为 MVP 验收）

#### 9.2.3 预处理 Tab
- 阈值替换：阈值 `5n` 时，`-4u` 能被替换（验证规则正确）
- 单位统一：所有可解析值能统一到目标单位
- 数值/单位分离：最后一列单位正确；只数值/只单位 Copy 正确
- 工程计数法：`12345` → `12.3E+03`
- 科学计数法 ↔ 工程单位 双向转换正确

---

## 10. 代码结构要求（≤ 5 个文件）

> 仅限制 `.py` 文件数量；资源与测试文件夹不计入。

建议拆分（示例）：
1. `app.py`：程序入口、主窗口、Tab 管理
2. `capture.py`：截图层/全局热键/区域选择逻辑
3. `ocr_engine.py`：PaddleOCR 封装、模型初始化、识别接口
4. `layout.py`：表格/文本布局重建（行列聚类、TSV 输出）
5. `postprocess.py`：阈值替换、单位换算、计数法转换、设置持久化（或 `config.py`）

---

## 11. 风险与约束说明（提前对齐预期）
- CPU-only 下 OCR 速度受图片大小影响显著；建议在 log 中明确耗时，并可加“缩放策略”（可选）。
- 表格结构恢复是启发式算法，遇到列间距不均、斜拍、透视会下降；允许用户在结果框手动修正。
- OCR 对 `u`、`n`、`m` 等字符易混淆（如 `μ`、`u`、`n`），建议做后处理纠错（可选）。

---

## 12. 交付物
- 可运行的 Windows 11 本地 Python 项目
- 源码（≤5 个 `.py` 文件）
- `README.md`：安装/运行/快捷键/常见问题
- 测试样例与对比说明（基于 test_pic）

---
